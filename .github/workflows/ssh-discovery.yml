name: 🔍 SSH Port Discovery - BioRuta

on:
  workflow_dispatch:  # Ejecutar manualmente
  
jobs:
  discover-ssh-port:
    name: 🔍 Descubrir Puerto SSH
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
      
      - name: 🔍 Probar múltiples puertos SSH
        run: |
          echo "🔍 Probando conectividad a diferentes puertos SSH..."
          
          HOST="${{ secrets.SSH_HOST }}"
          echo "🎯 Servidor objetivo: $HOST"
          
          # Instalar herramientas
          sudo apt-get update
          sudo apt-get install -y nmap netcat-openbsd
          
          echo "📡 Escaneando puertos comunes SSH..."
          
          # Puertos SSH comunes
          PORTS=(22 1244 2222 2244 8022 443 80)
          
          for port in "${PORTS[@]}"; do
            echo "🔌 Probando puerto $port..."
            
            # Test con netcat (timeout 5 segundos)
            if timeout 5 nc -zv $HOST $port 2>&1; then
              echo "✅ Puerto $port ABIERTO"
              
              # Si es un puerto SSH típico, probar SSH
              if [[ $port == 22 || $port == 1244 || $port == 2222 || $port == 2244 || $port == 8022 ]]; then
                echo "🔑 Probando SSH en puerto $port..."
                timeout 10 ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -p $port \
                  ${{ secrets.SSH_USER }}@$HOST "echo 'SSH funcional en puerto $port'" 2>&1 || true
              fi
            else
              echo "❌ Puerto $port cerrado/filtrado"
            fi
            echo "---"
          done
          
          echo "📊 Escaneo completo con nmap..."
          nmap -p 22,1244,2222,2244,8022 --open $HOST || echo "Nmap falló"
          
      - name: 🌐 Verificar conectividad web
        run: |
          echo "🌐 Probando puertos web..."
          HOST="${{ secrets.SSH_HOST }}"
          
          # Probar HTTP/HTTPS
          for port in 80 443 8080 3000 4000 5000; do
            echo "🔌 Puerto $port..."
            if timeout 5 nc -zv $HOST $port 2>&1; then
              echo "✅ Puerto $port abierto"
              # Probar HTTP
              curl -s --max-time 5 http://$HOST:$port/ > /dev/null && echo "📄 HTTP responde" || echo "📄 HTTP no responde"
            else
              echo "❌ Puerto $port cerrado"
            fi
          done
