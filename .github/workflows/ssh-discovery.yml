name: ğŸ” SSH Port Discovery - BioRuta

on:
  workflow_dispatch:  # Ejecutar manualmente
  
jobs:
  discover-ssh-port:
    name: ğŸ” Descubrir Puerto SSH
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ” Probar mÃºltiples puertos SSH
        run: |
          echo "ğŸ” Probando conectividad a diferentes puertos SSH..."
          
          HOST="${{ secrets.SSH_HOST }}"
          echo "ğŸ¯ Servidor objetivo: $HOST"
          
          # Instalar herramientas
          sudo apt-get update
          sudo apt-get install -y nmap netcat-openbsd
          
          echo "ğŸ“¡ Escaneando puertos comunes SSH..."
          
          # Puertos SSH comunes
          PORTS=(22 1244 2222 2244 8022 443 80)
          
          for port in "${PORTS[@]}"; do
            echo "ğŸ”Œ Probando puerto $port..."
            
            # Test con netcat (timeout 5 segundos)
            if timeout 5 nc -zv $HOST $port 2>&1; then
              echo "âœ… Puerto $port ABIERTO"
              
              # Si es un puerto SSH tÃ­pico, probar SSH
              if [[ $port == 22 || $port == 1244 || $port == 2222 || $port == 2244 || $port == 8022 ]]; then
                echo "ğŸ”‘ Probando SSH en puerto $port..."
                timeout 10 ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -p $port \
                  ${{ secrets.SSH_USER }}@$HOST "echo 'SSH funcional en puerto $port'" 2>&1 || true
              fi
            else
              echo "âŒ Puerto $port cerrado/filtrado"
            fi
            echo "---"
          done
          
          echo "ğŸ“Š Escaneo completo con nmap..."
          nmap -p 22,1244,2222,2244,8022 --open $HOST || echo "Nmap fallÃ³"
          
      - name: ğŸŒ Verificar conectividad web
        run: |
          echo "ğŸŒ Probando puertos web..."
          HOST="${{ secrets.SSH_HOST }}"
          
          # Probar HTTP/HTTPS
          for port in 80 443 8080 3000 4000 5000; do
            echo "ğŸ”Œ Puerto $port..."
            if timeout 5 nc -zv $HOST $port 2>&1; then
              echo "âœ… Puerto $port abierto"
              # Probar HTTP
              curl -s --max-time 5 http://$HOST:$port/ > /dev/null && echo "ğŸ“„ HTTP responde" || echo "ğŸ“„ HTTP no responde"
            else
              echo "âŒ Puerto $port cerrado"
            fi
          done
