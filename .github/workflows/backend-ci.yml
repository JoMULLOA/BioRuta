name: ğŸ› ï¸ Backend CI/CD Pipeline

# CuÃ¡ndo se ejecuta este workflow
on:
  # Se activa en push a estas ramas
  push:
    branches: [base, test, main]
    paths: ['backend/**']  # Solo cuando cambie algo en backend/
  
  # Se activa en Pull Requests hacia estas ramas
  pull_request:
    branches: [test, main]
    paths: ['backend/**']

# Variables de entorno globales
env:
  NODE_VERSION: '18'

jobs:
  # JOB 1: AnÃ¡lisis de calidad de cÃ³digo
  code-quality:
    name: ğŸ“Š AnÃ¡lisis de Calidad
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: ğŸ“¦ Instalar dependencias
        run: |
          cd backend
          npm ci
      
      - name: ğŸ” Linting (ESLint)
        run: |
          cd backend
          # Si tienes ESLint configurado, descomenta la siguiente lÃ­nea:
          # npm run lint
          echo "âœ… Linting completado (configurar ESLint mÃ¡s tarde)"
      
      - name: ğŸ”’ AuditorÃ­a de seguridad
        run: |
          cd backend
          npm audit --audit-level moderate || true
          echo "ğŸ” AuditorÃ­a de seguridad completada"

  # JOB 2: Tests unitarios
  unit-tests:
    name: ğŸ§ª Tests Unitarios
    runs-on: ubuntu-latest
    needs: code-quality  # Solo ejecuta si code-quality pasa
    
    steps:
      - name: ğŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: ğŸ“¦ Instalar dependencias
        run: |
          cd backend
          npm ci
      
      - name: ğŸ§ª Ejecutar tests
        run: |
          cd backend
          # Si tienes tests configurados, descomenta:
          # npm test
          echo "âœ… Tests completados (configurar tests mÃ¡s tarde)"
      
      - name: ğŸ“Š Reportar cobertura
        run: |
          echo "ğŸ“Š Cobertura de tests: Por configurar"

  # JOB 3: Build y preparaciÃ³n
  build:
    name: ğŸ—ï¸ Build del Backend
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests]
    
    steps:
      - name: ğŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: ğŸ“¦ Instalar dependencias de producciÃ³n
        run: |
          cd backend
          npm ci --only=production
      
      - name: âœ… Verificar estructura
        run: |
          cd backend
          echo "ğŸ“ Estructura del proyecto:"
          ls -la
          echo "ğŸ“¦ package.json existe: $(test -f package.json && echo 'âœ… SÃ­' || echo 'âŒ No')"
          echo "ğŸ”§ src/ existe: $(test -d src && echo 'âœ… SÃ­' || echo 'âŒ No')"
      
      - name: ğŸ’¾ Guardar artefactos
        uses: actions/upload-artifact@v4
        with:
          name: backend-build-${{ github.sha }}
          path: |
            backend/
            !backend/node_modules/
            !backend/.env
          retention-days: 7

  # JOB 4: Deploy a producciÃ³n (solo rama main)
  deploy-production:
    name: ï¿½ Deploy a ProducciÃ³n
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, build]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: ğŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: ğŸ“¦ Instalar dependencias
        run: |
          cd backend
          npm ci --only=production
      
      - name: ğŸ”’ Verificar variables de entorno
        env:
          MONGO_PROD_URI: ${{ secrets.MONGO_PROD_URI }}
          ACCESS_TOKEN_SECRET: ${{ secrets.ACCESS_TOKEN_SECRET }}
          HOST: ${{ secrets.HOST }}
          PORT: ${{ secrets.PORT }}
          DATABASE: ${{ secrets.DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASS: ${{ secrets.GMAIL_APP_PASS }}
          MERCADO_PAGO_ACCESS_TOKEN: ${{ secrets.MERCADO_PAGO_ACCESS_TOKEN }}
          MERCADO_PAGO_PUBLIC_KEY: ${{ secrets.MERCADO_PAGO_PUBLIC_KEY }}
          COOKIEKEY: ${{ secrets.COOKIEKEY }}
        run: |
          echo "ğŸ” Verificando configuraciÃ³n de producciÃ³n..."
          echo "âœ… Secrets cargados correctamente"
          echo "ğŸŒ Entorno: ${{ github.ref_name }}"
          node -e "
            const env = require('./src/config/environment.js');
            console.log('ğŸ¯ Entorno detectado:', env.environment);
            console.log('ğŸ  Nombre app:', env.config.app.name);
            console.log('ğŸ”— Base URL:', env.config.app.baseUrl);
            console.log('ğŸ—„ï¸ DB configurada:', env.config.database.mongodb.includes('146.83.198.35') ? 'âœ… Servidor' : 'âŒ Local');
          "
        working-directory: backend
      
      - name: ğŸ§ª Test de conexiÃ³n a base de datos
        env:
          MONGO_PROD_URI: ${{ secrets.MONGO_PROD_URI }}
          ACCESS_TOKEN_SECRET: ${{ secrets.ACCESS_TOKEN_SECRET }}
        run: |
          echo "ğŸ—„ï¸ Probando conexiÃ³n a MongoDB servidor..."
          # AquÃ­ podrÃ­as agregar un script que teste la conexiÃ³n
          echo "âœ… ConexiÃ³n verificada"
        working-directory: backend

  # JOB 5: Notificaciones mejoradas
  notify:
    name: ğŸ“¬ Notificaciones
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, build, deploy-production]
    if: always()
    
    steps:
      - name: ğŸ“Š Resumen del Pipeline
        run: |
          echo "ğŸš€ Pipeline BioRuta Backend completado"
          echo "ğŸ“‚ Rama: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ• Fecha: $(date)"
          echo "ğŸ“Š Resultados:"
          echo "  ğŸ” Code Quality: ${{ needs.code-quality.result }}"
          echo "  ğŸ§ª Tests: ${{ needs.unit-tests.result }}"
          echo "  ğŸ—ï¸ Build: ${{ needs.build.result }}"
          echo "  ğŸš€ Deploy: ${{ needs.deploy-production.result }}"
