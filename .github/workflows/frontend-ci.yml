name: ğŸ“± Frontend Flutter CI/CD Pipeline

# CuÃ¡ndo se ejecuta
on:
  push:
    branches: [base, test, main]
    paths: ['frontend/**']
  
  pull_request:
    branches: [test, main]
    paths: ['frontend/**']

# Variables globales
env:
  FLUTTER_VERSION: '3.16.x'  # Ajusta segÃºn tu versiÃ³n

jobs:
  # JOB 1: AnÃ¡lisis de Flutter
  flutter-analysis:
    name: ğŸ” AnÃ¡lisis Flutter
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ¦ Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: ğŸ“¦ Obtener dependencias
        run: |
          cd frontend
          flutter pub get
      
      - name: ğŸ” AnÃ¡lisis de cÃ³digo Dart
        run: |
          cd frontend
          flutter analyze
      
      - name: ğŸ“ Verificar formato
        run: |
          cd frontend
          flutter format --set-exit-if-changed --dry-run .

  # JOB 2: Tests Flutter
  flutter-tests:
    name: ğŸ§ª Tests Flutter
    runs-on: ubuntu-latest
    needs: flutter-analysis
    
    steps:
      - name: ğŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ¦ Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: ğŸ“¦ Obtener dependencias
        run: |
          cd frontend
          flutter pub get
      
      - name: ğŸ§ª Ejecutar tests
        run: |
          cd frontend
          flutter test
      
      - name: ğŸ“Š Generar reporte de tests
        run: |
          echo "ğŸ“Š Tests completados para Flutter"

  # JOB 3: Build Android (Rama base/test)
  build-android:
    name: ğŸ¤– Build Android
    runs-on: ubuntu-latest
    needs: [flutter-analysis, flutter-tests]
    if: github.ref == 'refs/heads/base' || github.ref == 'refs/heads/test'
    
    steps:
      - name: ğŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4
      
      - name: â˜• Configurar Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '11'
      
      - name: ğŸ¦ Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: ğŸ“¦ Obtener dependencias
        run: |
          cd frontend
          flutter pub get
      
      - name: ğŸ—ï¸ Build APK Debug
        run: |
          cd frontend
          flutter build apk --debug
      
      - name: ğŸ’¾ Guardar APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-debug-${{ github.sha }}
          path: frontend/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

  # JOB 4: Build Release (Solo rama main)
  build-release:
    name: ğŸš€ Build Release
    runs-on: ubuntu-latest
    needs: [flutter-analysis, flutter-tests]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Descargar cÃ³digo
        uses: actions/checkout@v4
      
      - name: â˜• Configurar Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '11'
      
      - name: ğŸ¦ Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      
      - name: ğŸ“¦ Obtener dependencias
        run: |
          cd frontend
          flutter pub get
      
      - name: ğŸ—ï¸ Build APK Release
        run: |
          cd frontend
          flutter build apk --release
      
      - name: ğŸ’¾ Guardar APK Release
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-release-${{ github.sha }}
          path: frontend/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

  # JOB 5: NotificaciÃ³n
  notify-flutter:
    name: ğŸ“¬ Notificaciones Flutter
    runs-on: ubuntu-latest
    needs: [flutter-analysis, flutter-tests, build-android]
    if: always()
    
    steps:
      - name: ğŸ“Š Resumen Flutter Pipeline
        run: |
          echo "ğŸ“± Flutter Pipeline completado para BioRuta"
          echo "ğŸ“‚ Rama: ${{ github.ref_name }}"
          echo "ğŸ”¨ Build Status: ${{ needs.build-android.result }}"
          echo "ğŸ§ª Tests Status: ${{ needs.flutter-tests.result }}"
